{"ast":null,"code":"const EventEmitter = require('events').EventEmitter;\n\nconst inherits = require('util').inherits;\n\nconst ethUtil = require('ethereumjs-util');\n\nconst EthBlockTracker = require('eth-block-tracker');\n\nconst map = require('async/map');\n\nconst eachSeries = require('async/eachSeries');\n\nconst Stoplight = require('./util/stoplight.js');\n\nconst cacheUtils = require('./util/rpc-cache-utils.js');\n\nconst createPayload = require('./util/create-payload.js');\n\nconst noop = function () {};\n\nmodule.exports = Web3ProviderEngine;\ninherits(Web3ProviderEngine, EventEmitter);\n\nfunction Web3ProviderEngine(opts) {\n  const self = this;\n  EventEmitter.call(self);\n  self.setMaxListeners(30); // parse options\n\n  opts = opts || {}; // block polling\n\n  const directProvider = {\n    sendAsync: self._handleAsync.bind(self)\n  };\n  const blockTrackerProvider = opts.blockTrackerProvider || directProvider;\n  self._blockTracker = opts.blockTracker || new EthBlockTracker({\n    provider: blockTrackerProvider,\n    pollingInterval: opts.pollingInterval || 4000\n  }); // handle new block\n\n  self._blockTracker.on('block', jsonBlock => {\n    const bufferBlock = toBufferBlock(jsonBlock);\n\n    self._setCurrentBlock(bufferBlock);\n  }); // emit block events from the block tracker\n\n\n  self._blockTracker.on('block', self.emit.bind(self, 'rawBlock'));\n\n  self._blockTracker.on('sync', self.emit.bind(self, 'sync'));\n\n  self._blockTracker.on('latest', self.emit.bind(self, 'latest')); // set initialization blocker\n\n\n  self._ready = new Stoplight(); // unblock initialization after first block\n\n  self._blockTracker.once('block', () => {\n    self._ready.go();\n  }); // local state\n\n\n  self.currentBlock = null;\n  self._providers = [];\n} // public\n\n\nWeb3ProviderEngine.prototype.start = function (cb = noop) {\n  const self = this; // start block polling\n\n  self._blockTracker.start().then(cb).catch(cb);\n};\n\nWeb3ProviderEngine.prototype.stop = function () {\n  const self = this; // stop block polling\n\n  self._blockTracker.stop();\n};\n\nWeb3ProviderEngine.prototype.addProvider = function (source) {\n  const self = this;\n\n  self._providers.push(source);\n\n  source.setEngine(this);\n};\n\nWeb3ProviderEngine.prototype.send = function (payload) {\n  throw new Error('Web3ProviderEngine does not support synchronous requests.');\n};\n\nWeb3ProviderEngine.prototype.sendAsync = function (payload, cb) {\n  const self = this;\n\n  self._ready.await(function () {\n    if (Array.isArray(payload)) {\n      // handle batch\n      map(payload, self._handleAsync.bind(self), cb);\n    } else {\n      // handle single\n      self._handleAsync(payload, cb);\n    }\n  });\n}; // private\n\n\nWeb3ProviderEngine.prototype._handleAsync = function (payload, finished) {\n  var self = this;\n  var currentProvider = -1;\n  var result = null;\n  var error = null;\n  var stack = [];\n  next();\n\n  function next(after) {\n    currentProvider += 1;\n    stack.unshift(after); // Bubbled down as far as we could go, and the request wasn't\n    // handled. Return an error.\n\n    if (currentProvider >= self._providers.length) {\n      end(new Error('Request for method \"' + payload.method + '\" not handled by any subprovider. Please check your subprovider configuration to ensure this method is handled.'));\n    } else {\n      try {\n        var provider = self._providers[currentProvider];\n        provider.handleRequest(payload, next, end);\n      } catch (e) {\n        end(e);\n      }\n    }\n  }\n\n  function end(_error, _result) {\n    error = _error;\n    result = _result;\n    eachSeries(stack, function (fn, callback) {\n      if (fn) {\n        fn(error, result, callback);\n      } else {\n        callback();\n      }\n    }, function () {\n      // console.log('COMPLETED:', payload)\n      // console.log('RESULT: ', result)\n      var resultObj = {\n        id: payload.id,\n        jsonrpc: payload.jsonrpc,\n        result: result\n      };\n\n      if (error != null) {\n        resultObj.error = {\n          message: error.stack || error.message || error,\n          code: -32000\n        }; // respond with both error formats\n\n        finished(error, resultObj);\n      } else {\n        finished(null, resultObj);\n      }\n    });\n  }\n}; //\n// from remote-data\n//\n\n\nWeb3ProviderEngine.prototype._setCurrentBlock = function (block) {\n  const self = this;\n  self.currentBlock = block;\n  self.emit('block', block);\n}; // util\n\n\nfunction toBufferBlock(jsonBlock) {\n  return {\n    number: ethUtil.toBuffer(jsonBlock.number),\n    hash: ethUtil.toBuffer(jsonBlock.hash),\n    parentHash: ethUtil.toBuffer(jsonBlock.parentHash),\n    nonce: ethUtil.toBuffer(jsonBlock.nonce),\n    sha3Uncles: ethUtil.toBuffer(jsonBlock.sha3Uncles),\n    logsBloom: ethUtil.toBuffer(jsonBlock.logsBloom),\n    transactionsRoot: ethUtil.toBuffer(jsonBlock.transactionsRoot),\n    stateRoot: ethUtil.toBuffer(jsonBlock.stateRoot),\n    receiptsRoot: ethUtil.toBuffer(jsonBlock.receiptRoot || jsonBlock.receiptsRoot),\n    miner: ethUtil.toBuffer(jsonBlock.miner),\n    difficulty: ethUtil.toBuffer(jsonBlock.difficulty),\n    totalDifficulty: ethUtil.toBuffer(jsonBlock.totalDifficulty),\n    size: ethUtil.toBuffer(jsonBlock.size),\n    extraData: ethUtil.toBuffer(jsonBlock.extraData),\n    gasLimit: ethUtil.toBuffer(jsonBlock.gasLimit),\n    gasUsed: ethUtil.toBuffer(jsonBlock.gasUsed),\n    timestamp: ethUtil.toBuffer(jsonBlock.timestamp),\n    transactions: jsonBlock.transactions\n  };\n}","map":{"version":3,"sources":["F:/7color/node_modules/@0x/subproviders/node_modules/web3-provider-engine/index.js"],"names":["EventEmitter","require","inherits","ethUtil","EthBlockTracker","map","eachSeries","Stoplight","cacheUtils","createPayload","noop","module","exports","Web3ProviderEngine","opts","self","call","setMaxListeners","directProvider","sendAsync","_handleAsync","bind","blockTrackerProvider","_blockTracker","blockTracker","provider","pollingInterval","on","jsonBlock","bufferBlock","toBufferBlock","_setCurrentBlock","emit","_ready","once","go","currentBlock","_providers","prototype","start","cb","then","catch","stop","addProvider","source","push","setEngine","send","payload","Error","await","Array","isArray","finished","currentProvider","result","error","stack","next","after","unshift","length","end","method","handleRequest","e","_error","_result","fn","callback","resultObj","id","jsonrpc","message","code","block","number","toBuffer","hash","parentHash","nonce","sha3Uncles","logsBloom","transactionsRoot","stateRoot","receiptsRoot","receiptRoot","miner","difficulty","totalDifficulty","size","extraData","gasLimit","gasUsed","timestamp","transactions"],"mappings":"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","sourcesContent":["const EventEmitter = require('events').EventEmitter\r\nconst inherits = require('util').inherits\r\nconst ethUtil = require('ethereumjs-util')\r\nconst EthBlockTracker = require('eth-block-tracker')\r\nconst map = require('async/map')\r\nconst eachSeries = require('async/eachSeries')\r\nconst Stoplight = require('./util/stoplight.js')\r\nconst cacheUtils = require('./util/rpc-cache-utils.js')\r\nconst createPayload = require('./util/create-payload.js')\r\nconst noop = function(){}\r\n\r\nmodule.exports = Web3ProviderEngine\r\n\r\n\r\ninherits(Web3ProviderEngine, EventEmitter)\r\n\r\nfunction Web3ProviderEngine(opts) {\r\n  const self = this\r\n  EventEmitter.call(self)\r\n  self.setMaxListeners(30)\r\n  // parse options\r\n  opts = opts || {}\r\n\r\n  // block polling\r\n  const directProvider = { sendAsync: self._handleAsync.bind(self) }\r\n  const blockTrackerProvider = opts.blockTrackerProvider || directProvider\r\n  self._blockTracker = opts.blockTracker || new EthBlockTracker({\r\n    provider: blockTrackerProvider,\r\n    pollingInterval: opts.pollingInterval || 4000,\r\n  })\r\n\r\n  // handle new block\r\n  self._blockTracker.on('block', (jsonBlock) => {\r\n    const bufferBlock = toBufferBlock(jsonBlock)\r\n    self._setCurrentBlock(bufferBlock)\r\n  })\r\n\r\n  // emit block events from the block tracker\r\n  self._blockTracker.on('block', self.emit.bind(self, 'rawBlock'))\r\n  self._blockTracker.on('sync', self.emit.bind(self, 'sync'))\r\n  self._blockTracker.on('latest', self.emit.bind(self, 'latest'))\r\n\r\n  // set initialization blocker\r\n  self._ready = new Stoplight()\r\n  // unblock initialization after first block\r\n  self._blockTracker.once('block', () => {\r\n    self._ready.go()\r\n  })\r\n  // local state\r\n  self.currentBlock = null\r\n  self._providers = []\r\n}\r\n\r\n// public\r\n\r\nWeb3ProviderEngine.prototype.start = function(cb = noop){\r\n  const self = this\r\n  // start block polling\r\n  self._blockTracker.start().then(cb).catch(cb)\r\n}\r\n\r\nWeb3ProviderEngine.prototype.stop = function(){\r\n  const self = this\r\n  // stop block polling\r\n  self._blockTracker.stop()\r\n}\r\n\r\nWeb3ProviderEngine.prototype.addProvider = function(source){\r\n  const self = this\r\n  self._providers.push(source)\r\n  source.setEngine(this)\r\n}\r\n\r\nWeb3ProviderEngine.prototype.send = function(payload){\r\n  throw new Error('Web3ProviderEngine does not support synchronous requests.')\r\n}\r\n\r\nWeb3ProviderEngine.prototype.sendAsync = function(payload, cb){\r\n  const self = this\r\n  self._ready.await(function(){\r\n\r\n    if (Array.isArray(payload)) {\r\n      // handle batch\r\n      map(payload, self._handleAsync.bind(self), cb)\r\n    } else {\r\n      // handle single\r\n      self._handleAsync(payload, cb)\r\n    }\r\n\r\n  })\r\n}\r\n\r\n// private\r\n\r\nWeb3ProviderEngine.prototype._handleAsync = function(payload, finished) {\r\n  var self = this\r\n  var currentProvider = -1\r\n  var result = null\r\n  var error = null\r\n\r\n  var stack = []\r\n\r\n  next()\r\n\r\n  function next(after) {\r\n    currentProvider += 1\r\n    stack.unshift(after)\r\n\r\n    // Bubbled down as far as we could go, and the request wasn't\r\n    // handled. Return an error.\r\n    if (currentProvider >= self._providers.length) {\r\n      end(new Error('Request for method \"' + payload.method + '\" not handled by any subprovider. Please check your subprovider configuration to ensure this method is handled.'))\r\n    } else {\r\n      try {\r\n        var provider = self._providers[currentProvider]\r\n        provider.handleRequest(payload, next, end)\r\n      } catch (e) {\r\n        end(e)\r\n      }\r\n    }\r\n  }\r\n\r\n  function end(_error, _result) {\r\n    error = _error\r\n    result = _result\r\n\r\n    eachSeries(stack, function(fn, callback) {\r\n\r\n      if (fn) {\r\n        fn(error, result, callback)\r\n      } else {\r\n        callback()\r\n      }\r\n    }, function() {\r\n      // console.log('COMPLETED:', payload)\r\n      // console.log('RESULT: ', result)\r\n\r\n      var resultObj = {\r\n        id: payload.id,\r\n        jsonrpc: payload.jsonrpc,\r\n        result: result\r\n      }\r\n\r\n      if (error != null) {\r\n        resultObj.error = {\r\n          message: error.stack || error.message || error,\r\n          code: -32000\r\n        }\r\n        // respond with both error formats\r\n        finished(error, resultObj)\r\n      } else {\r\n        finished(null, resultObj)\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\n//\r\n// from remote-data\r\n//\r\n\r\nWeb3ProviderEngine.prototype._setCurrentBlock = function(block){\r\n  const self = this\r\n  self.currentBlock = block\r\n  self.emit('block', block)\r\n}\r\n\r\n// util\r\n\r\nfunction toBufferBlock (jsonBlock) {\r\n  return {\r\n    number:           ethUtil.toBuffer(jsonBlock.number),\r\n    hash:             ethUtil.toBuffer(jsonBlock.hash),\r\n    parentHash:       ethUtil.toBuffer(jsonBlock.parentHash),\r\n    nonce:            ethUtil.toBuffer(jsonBlock.nonce),\r\n    sha3Uncles:       ethUtil.toBuffer(jsonBlock.sha3Uncles),\r\n    logsBloom:        ethUtil.toBuffer(jsonBlock.logsBloom),\r\n    transactionsRoot: ethUtil.toBuffer(jsonBlock.transactionsRoot),\r\n    stateRoot:        ethUtil.toBuffer(jsonBlock.stateRoot),\r\n    receiptsRoot:     ethUtil.toBuffer(jsonBlock.receiptRoot || jsonBlock.receiptsRoot),\r\n    miner:            ethUtil.toBuffer(jsonBlock.miner),\r\n    difficulty:       ethUtil.toBuffer(jsonBlock.difficulty),\r\n    totalDifficulty:  ethUtil.toBuffer(jsonBlock.totalDifficulty),\r\n    size:             ethUtil.toBuffer(jsonBlock.size),\r\n    extraData:        ethUtil.toBuffer(jsonBlock.extraData),\r\n    gasLimit:         ethUtil.toBuffer(jsonBlock.gasLimit),\r\n    gasUsed:          ethUtil.toBuffer(jsonBlock.gasUsed),\r\n    timestamp:        ethUtil.toBuffer(jsonBlock.timestamp),\r\n    transactions:     jsonBlock.transactions,\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"script"}